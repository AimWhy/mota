<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>使用 Hook API - Mota</title>
  <meta name="keywords" content="使用 Hook API" />
  <meta name="description" content="使用 Hook API" />
  <meta name="author" content="doczilla">
  <base href="../../" route="%7B%22lang%22%3A%22zh%22%2C%22group%22%3A%22guide%22%2C%22doc%22%3A%22use_model%22%7D" />
  <link href="./assets/index.css" rel="stylesheet">
  <link href="./plugins/doczilla-card/index.css" rel="stylesheet" /><link href="./plugins/doczilla-details/index.css" rel="stylesheet" /><link href="./plugins/doczilla-highlight/index.css" rel="stylesheet" /></head>
</head>

<body>
  <div id="root"><div data-reactroot=""><nav class="navbar navbar-default"><div class="container-fluid"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="./"><i class="icon fa fa-graduation-cap" aria-hidden="true"></i><span class="name">Mota</span></a></div><div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1"><form class="navbar-form navbar-left"><div class="form-group search"><span class="separator"></span><input type="text" class="form-control" placeholder="Search by keyword ..." value=""/></div></form><ul class="nav navbar-nav navbar-right"><li><a href="//houfeng.net/mota/">文档</a></li><li><a href="//github.com/Houfeng/mota">GitHub</a></li><li><a href="//houfeng.net/dn-template-mota/example/">示例</a></li><li class="dropdown locales"><a class="dropdown-toggle" data-toggle="dropdown" role="button">中文<!-- --> <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="zh/guide/use_model.html">中文</a></li></ul></li></ul></div></div></nav><div class="container"><div class="panel panel-default"><div class="panel-body"><div class="row"><div class="col-md-3 col-side"><div class="catalog"><ul class="group"><li class="group-item"><a><i class="fa fa-bookmark" aria-hidden="true"></i>使用指南</a><ul class="doc"><li class="doc-item"><a class="" href="zh/guide/quick.html">快速开始</a></li><li class="doc-item"><a class="" href="zh/guide/model.html">编写业务模型</a></li><li class="doc-item"><a class="" href="zh/guide/mapping.html">属性映射</a></li><li class="doc-item"><a class="" href="zh/guide/autorun.html">自执行函数</a></li><li class="doc-item"><a class="" href="zh/guide/watch.html">监听模型变化</a></li><li class="doc-item"><a class="" href="zh/guide/binding.html">数据绑定</a></li><li class="doc-item"><a class="active" href="zh/guide/use_model.html">使用 Hook API</a></li><li class="doc-item"><a class="" href="zh/guide/hook_model.html">面向 Hook 的模型</a></li><li class="doc-item"><a class="" href="zh/guide/typescript.html">在 TS 中使用</a></li></ul></li></ul></div></div><div class="col-md-9 col-main"><div class="article markdown-body"><h1 id="%E4%BD%BF%E7%94%A8-hook-api">使用 Hook API</h1>
<h3 id="%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D">简单介绍</h3>
<p>在 React 发布包含 <code>Hooks</code> 的 <code>alpah</code> 版后，Mota 也在 <code>next</code> 版本中新增支持了 Hook 风格的 API，随着 React <code>v16.8</code> 版本的发布带来了稳定版的 <code>Hooks</code> 支持。</p>
<p>目前，Mota 已经在稳定版中，提供了 <code>Hook API</code> 的支持，利用 React 的 <code>Hooks</code> 可以让你在不编写类的情况下使用 <code>state</code> 和 React 的其他功能。而使用 Mota 极少的 <code>Hook API</code> 将给应用带来 Hook 风格可响应的全局状态管理支持。</p>
<h3 id="%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95">基本用法</h3>
<pre><code class="language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//通过 useModel 拿到一个可响应的 model</span>
  <span class="token keyword">const</span> model <span class="token operator">=</span> <span class="token function">useModel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span><span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//定义累加按钮事件</span>
  <span class="token keyword">const</span> onClick <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span>model<span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//--</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">></span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span><span class="token punctuation">{</span>model<span class="token punctuation">.</span>count<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>onClick<span class="token punctuation">}</span><span class="token operator">></span>click me<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App<span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementId</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>仅有一个新增 API <code>useModel</code>，通过 <code>useModel</code> 可在一个 <code>Function Component</code> 中使用 <code>model</code>，如同在 <code>Class Component</code> 中的 <code>@model</code>，此时的 <code>model</code> 依然是可响应的，执行时会对组件进行「依赖收集」，当操作 <code>model</code> 的成员时（比如 <code>model.count=1</code> 的赋值操作），Mota 会自动发现组件依赖的数据发生了变化并通知组件进行更新。</p>
<h3 id="%E8%BF%9B%E9%98%B6%E8%AF%B4%E6%98%8E">进阶说明</h3>
<p>在基本用法中提到了一个关键词「依赖收集」，通过 <code>useModel</code> 拿到了可响应的 <code>model</code>，默认情况下只有被组件依赖的模型数据发生了变化组件才会更新，比如下边的示例代码中，只有在 <code>model.a</code> 发生变化时，组件才会重新渲染。</p>
<pre><code class="language-js"><span class="token keyword">function</span> <span class="token function">Demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> model <span class="token operator">=</span> <span class="token function">useModel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> a<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span><span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">></span><span class="token punctuation">{</span>model<span class="token punctuation">.</span>a<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
<span class="token punctuation">}</span>
</code></pre>
<p>实际开发过程中有时「组件依赖了模型上的某个对象，但希望这个对象的子成员发生变化时，组件也要重新渲染」</p>
<pre><code class="language-js"><span class="token keyword">function</span> <span class="token function">Demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> info <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useModel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> info<span class="token punctuation">:</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'test'</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>Info data<span class="token operator">=</span><span class="token punctuation">{</span>info<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">></span>
<span class="token punctuation">}</span>
</code></pre>
<p>因为对于 <code>Demo</code> 来说只依赖了 <code>info</code>，而 <code>info</code> 的引用是一直没有变化的，所以在 <code>info.name</code> 发生变化时 <code>Demo</code> 并不会重新渲染。那这样 <code>Info</code> 组件会一直显示旧的数据。</p>
<p>如何处理这个问题？</p>
<p>一个方法是让 <code>Info</code> 也通过 <code>useModel</code> 有自已的 <code>model</code>，那 <code>Info</code> 的依赖会被独立解析，比如</p>
<pre><code class="language-js"><span class="token keyword">function</span> <span class="token function">Info</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token function">useModel</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">></span><span class="token punctuation">{</span>info<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
<span class="token punctuation">}</span>
</code></pre>
<p>这个虽然 <code>Demo</code> 不会重新渲染，但 Mota 会发现 <code>Info</code> 依赖了 <code>info.name</code>，但发现数据变化时，<code>Info</code> 会自动更新。</p>
<p>还有一个方法是，在更新 <code>info.name</code> 时换一个写法</p>
<pre><code class="language-js"><span class="token comment">//通常的直接给 name 赋值</span>
model<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'test'</span><span class="token punctuation">;</span>
<span class="token comment">//如下的给 info 赋值的写法，会让 Demo 发现 info 的变化</span>
model<span class="token punctuation">.</span>info <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">...</span>model<span class="token punctuation">.</span>info<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'test'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>除了上述的两个方法，还有一个方法就是通过 <code>useModel</code> 的第二个参数显示的声明额外的依赖，第二个参数可是一个数组，数组中是显式声明的依赖，格式为子成员的路径，如下</p>
<pre><code class="language-js"><span class="token keyword">function</span> <span class="token function">Demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> info <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useModel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
    info<span class="token punctuation">:</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'test'</span><span class="token punctuation">}</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'info.name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>Info data<span class="token operator">=</span><span class="token punctuation">{</span>info<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">></span>
<span class="token punctuation">}</span>
</code></pre>
<p>但有时时模型数据是一个数组，我们无法直接指定每个子元素的路径，这时第二个参数还可以是一个函数，函数的参数是「变化的模型数据的路径」，可参函数中返回 <code>boolean</code> 值决定是否需要更新组件，如下</p>
<pre><code class="language-js"><span class="token keyword">function</span> <span class="token function">Demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> info <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useModel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
    info<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'test1'</span><span class="token punctuation">}</span><span class="token punctuation">]</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span> p<span class="token operator">=></span> p<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>Info data<span class="token operator">=</span><span class="token punctuation">{</span>info<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">></span>
<span class="token punctuation">}</span>
</code></pre>
<p>示例中通过用 <code>endsWith</code> 路径是不是 <code>*.name</code> 结尾的决定要不要更新，当然也可以用更多的判断方法决定要不要更新。</p>
</div></div></div></div></div></div><footer class="footer">Powered By <!-- -->doczilla<!-- --> v<!-- -->3.2.2</footer></div></div>
  <script src="./data.js"></script>
  <script src="./assets/index.js"></script>
  <script src="./plugins/doczilla-highlight/index.js"></script></body>
</body>

</html>